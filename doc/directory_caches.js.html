<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: directory_caches.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: directory_caches.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>

const path = require('path')

/**
 * DirectoryCache
 * 
 * The aim of this class is to take care of loading files from a directory
 *  and backing them up at intervals.
 * 
 * This class has an option to use or not use the caching version of the file system oeprations.
 * 
 * This class will start the backup process if the backup interval and the directory have been specified.
 * 
 * This class does not call the `load_directory` method upon construction. 
 * The application must call it. In particular, it must call the class `load_directory`
 * method with an item injector, a function that puts elements into the object list
 * provided in the configuration. This class does not operate on the list directly,
 * it calls the injector.
 * 
 * 
 * Fields of Conf:
 * 
 * * default_directory
 * * noisy              -- whether to print log messages or not
 * * crash_cant_load    -- turns off reloading after a crash
 * * file_namer         -- a function that names files on behalf of the application per object stored
 * * object_list        -- reference to a list that another part of an application will grow and shrink; 
 *                          This class just writes the objects to disk.
 * * use_caching        -- off by default. If on, then the caching version of the file operation is used
 * * backup_interval    -- time to wait between backups in miliseconds
 * 
 */
class DirectoryCache {
    
    /**
     * DirectoryCache.constructor
     * 
     * The constructor has just one parameter. See "Fields of Conf".
     * 
     * @param {object} conf 
     */
    constructor(conf) {
        if ( conf === undefined ) throw new Error("DirectoryCache: no configuration")
        this._dir = conf.default_directory
        this._noisy = conf.noisy
        this._crash_cant_load = conf.crash_cant_load
        this._file_namer = (typeof conf.file_namer === 'string') ? require(conf.file_namer) : conf.file_namer // should be a function
        if ( typeof this._file_namer !== 'function' ) {
            throw new Error("DirectoryCache ... constructor, configured file name is not a function ")
        }
        this._iterable_from_conf = conf.object_list ? conf.object_list : false
        //
        const FOSClass = conf.use_caching ? require('./file_ops_cache') : require('./file_ops')
        this.fos = new FOSClass(conf)
        //
        this.conf = conf
        if ( conf ) {
            if ( conf.backup_interval &amp;&amp; (this._dir) ) {
                let b_interval = parseInt(conf.backup_interval)
                this.start(b_interval)
            }
        }
    }


    /**
     * load_directory
     * 
     * The directory consists of a number of files each containing one JSON object.
     * The most likely case will be that the objects are fairly large. Or, there will be many small
     * files. It is possible that the item injector takes an array of objects as well. 
     * 
     * The `base_dir` is the directory (abolute or relative to the application cwd).
     * This method can override the `base_dir` set in the configuration. Otherwise, it can be left
     * empty or string 'default' can be passed, where this method reserves the string 'default' to 
     * select the configured `base_dir`.
     * 
     * `after_action` is some code supplied by the application and is optional.
     * It can take in an array of errors if the application wants to process errors
     * that may occur in loading files. Otherwise, no information is passed on to the method.
     * 
     * 
     * @param {string} dpath -- a path relative to the base directory
     * @param {function} item_injector - a method taking one object
     * @param {string} base_dir -- this base dir can override the configured one or be set to use it.
     * @param {function} after_action -- a call back. 
     */

    async load_directory(dpath,item_injector,base_dir,after_action) {
        if ( base_dir === 'default' || (base_dir === undefined) ) base_dir = this._dir
        if ( typeof item_injector !== 'function' ) throw new Error("load_directory: item_injector is no a function")
        let dir_path = ''
        if ( base_dir ) {
            dir_path = `${base_dir}/${dpath}`
        }
        //
        let files = await this.fos.dir_reader(dir_path)
        //
        let errs = []
        for ( let file of files ) {
            if ( path.extname(file) == ".json" ) {
                if ( this._noisy ) {
                    console.log(file)
                }
                //
                let fpath = `${dir_path}/${file}`
                let f_obj = await this.fos.load_json_data_at_path(fpath)
                try {
                    item_injector(f_obj)             // ITEM INJECTO       
                } catch (e) {
                    errs.push(e)
                    console.log("load_directory:: failed item injection")
                }
            } 
        }
        //
        if ( typeof after_action ==='function' ) {
            after_action(errs)
        }
    }

    
    /**
     * backup_to_directory
     * 
     * The applicaetion may call this method directly, or the application may configure
     * the interval function, which calls this method.
     * 
     * @param {function} file_namer -- given an object, this method should return a string for a file name
     * @param {string} base_dir -- this base dir can override the configured one or be set to use it.
     * @param {Iterable} list -- list is an iterable that provides access to writable objects
     * @param {number} ce_flags -- see node.js file system documentation for flags to use in writing to a file.
     */
    async backup_to_directory(file_namer,base_dir,list,ce_flags) {
        if ( !(base_dir) ) base_dir = this._dir
        if ( typeof file_namer !== 'function' ) throw new Error(`backup_to_directory: file_name is not a function`)
        let all_file_p = []
        if ( list === undefined ) {
            list = this._iterable_from_conf
        }
        if ( list ) {
            for ( let datum of list ) {
                let fname = file_namer(datum)
                let path = `${base_dir}/${fname}.json`
                let p = this.fos.write_out_json(path,datum,ce_flags)
                all_file_p.push(p)
            }
            await Promise.all(all_file_p)    
        }
    }

    /**
     * get_fos
     * 
     * @returns object -- the file operation object this directory cache is using
     */
    get_fos() {         // so that a module does not have to load more than one component
        return this.fos
    }


    /**
     * stop
     */
    stop() {
        if ( this._sync_interval ) {
            clearInterval(this._sync_interval)
            this._sync_interval = null
        }
    }

    /**
     * start
     * 
     * Calls setInterval with a thunk wrapping `backup_to_directory`
     * 
     * @param {number} b_interval -- integer required for setInterval (**b**ackup interval)
     */
    start(b_interval) {
        if ( this._sync_interval ) {
            this.stop()
        }
        this._sync_interval = setInterval(() => {
            this.backup_to_directory(this._file_namer,this._dir)
        },b_interval)
    }

}




module.exports = DirectoryCache</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DefaultCacheTable.html">DefaultCacheTable</a></li><li><a href="DirectoryCache.html">DirectoryCache</a></li><li><a href="FileOperations.html">FileOperations</a></li><li><a href="FileOperationsCache.html">FileOperationsCache</a></li><li><a href="FsExtra.html">FsExtra</a></li><li><a href="PathManager.html">PathManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Oct 22 2025 15:58:34 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
